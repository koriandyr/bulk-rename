# Shared AI Assistant Instructions

This file contains common instructions for all AI coding assistants working with this repository.
Tool-specific files should reference this content to maintain consistency.

## Repository Overview

This repository contains personal utility scripts, primarily focused on media file processing. The main component is `bulk_rename/` - a Python script that batch renames image/video files using creation dates and converts formats.

## Architecture & Data Flow

**bulk_rename.py** processes media files in three sequential phases:

1. **Metadata Collection** (`collect_file_metadata()`)
   - Parallel extraction using `ThreadPoolExecutor` (MAX_WORKERS=4)
   - Extracts timestamps from EXIF (images) or Windows Property System/ffprobe (videos)
   - Falls back to file modification time if metadata unavailable
   - Returns `FileMetadata` dataclasses with reliability flags

2. **File Conversion** (`convert_files()`)
   - HEIC→JPG using `magick` command (ImageMagick)
   - MOV→MP4 using `ffmpeg` command
   - Originals sent to Recycle Bin via `send2trash`

3. **File Renaming** (`rename_files()`)
   - Renames to `YYYYMMDD-SEQUENCE[EXTRA_TEXT]` format
   - Only processes files matching `PATTERNS_TO_RENAME` regexes
   - Skips already-renamed files (matching `DEST_PATTERN`)

**Key Data Structures:**
- `FileMetadata` dataclass: path, timestamp, extension, reliability info
- `ProcessingStats` dataclass: conversion/rename counts
- Constants as `frozenset`: `ALLOWED_SUFFIXES`, `IMG_FORMATS`, `VIDEO_FORMATS`

## Critical Workflows

### Development Setup
```bash
# Install all dependencies
pip install -r requirements.txt
pip install -r requirements-dev.txt

# Run quality checks (must pass 10.00 pylint, 100% coverage)
python -m pylint bulk_rename/
python -m pylint tests/
python -m pytest tests/test_bulk_rename.py -v --cov=bulk_rename --cov-report=term-missing
```

### Testing Script Safely
```bash
# Always test in dry-run mode first (default behavior)
python -m bulk_rename --folder /path/to/test/folder

# Or if installed as package
bulk-rename --folder /path/to/test/folder

# Apply changes only when confident
python -m bulk_rename --folder /path/to/test/folder --commit
bulk-rename --folder /path/to/test/folder --commit
```

### CI/CD Pipeline
- **Security scanning**: Bandit (Python SAST), Safety (SCA), Semgrep (multi-language)
- **Quality gates**: 100% coverage, 10.00 pylint, all tests pass
- **Platform**: Windows (matches development environment)
- **External tools**: Requires ImageMagick (`magick`) and FFmpeg (`ffmpeg`) in PATH

## Code Conventions

### Naming & Style
- **Constants**: `UPPER_SNAKE_CASE` (module-level only)
- **Functions**: `lower_snake_case`
- **Classes**: `PascalCase`
- **Unused variables**: Prefix with `_` (e.g., `_result`, `*_args`)
- **Quality**: PEP 8, 10.00 pylint, Google docstrings, type hints
- **.gitignore**: exclude all non-project files (e.g., `__pycache__/`, `.vscode/`, `.env`)
- **Secrets**: never include secrets, API keys, passwords, or sensitive information in the codebase or commit history.
- **Logging**: Use `logging` module with appropriate levels (DEBUG, INFO, WARNING, ERROR)
- **Path handling**: Use `pathlib.Path` for all file/directory operations
- **F-strings**: Use f-strings for all string formatting, except in logging statements
- **Type hints**: Use `typing` module for all function signatures and complex types
- **Immutability**: Use `frozenset` for constant collections to prevent accidental modification
- **Dataclasses**: Use `@dataclass` for structured data objects instead of plain tuples/dicts
- **Parallelism**: Use `concurrent.futures.ThreadPoolExecutor` for I/O-bound parallel tasks
- **File operations**: Use `send2trash` for safe deletions to Recycle Bin instead of permanent removal
- **Regex patterns**: Precompile regexes at module level for performance and clarity

### Module Headers
All Python modules require comprehensive module docstrings with:
- Brief description of purpose
- Key features/capabilities
- Usage examples (when applicable)
- Dependencies list
- See `main.py` and `test_bulk_rename.py` for examples

### Testing Standards
- Use pytest fixtures for common setup
- Mock external dependencies (file system, subprocess calls, api calls, etc.)
- 100% coverage required (no `# pragma: no cover` except entry points)
- Tests follow same quality standards as production code

### Error Handling
- Use specific exception types (OSError, ValueError, etc.)
- Log errors with context using `logger.exception()` or `logger.error()`
- Graceful fallbacks (metadata → file timestamp → skip)

## Integration Points

### External Dependencies
- **ImageMagick**: `magick` command for HEIC conversion
- **FFmpeg/FFprobe**: Video processing and metadata extraction
- **Windows-specific**: `pywin32.propsys` for video metadata, Recycle Bin deletions

### File Patterns
Only rename files matching these compiled regexes:
- `IMG_`, `IMG_E`, `VD_` followed by digits
- Pure numeric filenames
- Four letters + four digits (e.g., `ABCD1234`)
- `BulkPics` + digits
- `P` + letter/digit + six digits

### Metadata Sources (priority order)
1. EXIF `DateTimeOriginal` (images)
2. EXIF `DateTime` (images)
3. Windows Property System `PKEY_Media_DateEncoded` (videos)
4. FFprobe `creation_time` (videos)
5. File modification time (fallback)

## Common Patterns

### Dataclass Usage
```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class FileMetadata:
    original_path: Path
    timestamp: datetime
    extension: str
    original_name: str
    metadata_reliable: bool
    timestamp_source: str
```

### Parallel Processing
```python
from concurrent.futures import ThreadPoolExecutor
import logging

def collect_file_metadata(file_list: list[Path], logger: logging.Logger) -> list[FileMetadata]:
    with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        futures = [executor.submit(_extract_single_file_metadata, f, logger) for f in file_list]
        return [f.result() for f in futures if f.result()]
```

### Safe File Operations
```python
from send2trash import send2trash

# Use Recycle Bin instead of permanent deletion
try:
    send2trash(str(file_path))
    logger.info("Sent to Recycle Bin: %s", file_path.name)
except OSError as e:
    logger.error("Failed to recycle: %s", e)
```

### Logging Setup
```python
from logging.handlers import TimedRotatingFileHandler

def setup_logger(script_name: str) -> logging.Logger:
    logger = logging.getLogger(__name__)
    handler = TimedRotatingFileHandler(f"{script_name}.log", when="d", backupCount=10)
    logger.addHandler(handler)
    logger.addHandler(logging.StreamHandler())
    logger.setLevel(logging.DEBUG)
    return logger
```

## Key Files

- `bulk_rename/main.py`: Main script module (585 lines, 10.00 pylint)
- `bulk_rename/__init__.py`: Package initialization and exports
- `tests/test_bulk_rename.py`: Comprehensive tests (1275 lines, 100% coverage)
- `requirements.txt`: Runtime deps (Pillow, send2trash, pywin32)
- `requirements-dev.txt`: Dev deps (pylint, pytest, etc.)
- `pyproject.toml`: Package configuration and metadata
- `.github/workflows/ci.yml`: CI pipeline with security scanning and quality gates</content>
<parameter name="filePath">e:\git\personal\.ai-instructions.md